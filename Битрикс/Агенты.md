
Агенты - технология способная запускать скрипты с некоторой периодичностью

---

Имя функции должно заканчиваться словом Agent и должна возвращать строку состоящую из имени функции с переданным параметром. Она возвращает строку с сигнатурой для вызова другими функциями (Агентами)

```php
function checkNewsCountAgent(int $lastId = 0){
	return __METHOD__."($lastId);";
    return "checkNewsCountAgent($lastId);";
}
```

---

Должны находиться в папке lib/agents

Настройки - Настройки продукта - Агенты

Изменить путь к методу
MyCompany\Custom\Agents\NewsCount::checkNewsCountAgent();

--- 
#### На php-код, отвечающий за выполнение агента, накладываются некоторые ограничения:

- Нельзя использовать переменную $USER.
- Нельзя проводить авторизацию.
- Нельзя использовать константу SITE_ID, так как агент может выполняться в административном разделе, а там она инициализируется иначе.
- Если агент не завершился за 10 минут, система считает, что произошла ошибка и вызовет агент снова.
- Если агент повторяющийся — он должен возвращать строку, eval которой приведет к его вызову.

>[!Note]
>Чтобы отслеживать агенты, разработчик может проверить их время последнего запуска и запланированное время следующего в списке агентов в разделе администратора, или воспользоваться константой `BX_AGENTS_LOG_FUNCTION`.

Если объявить эту константу (например, в init.php) и указать в ней имя объявленной функции, то эта функция будет вызываться при запуске каждого агента и при его завершении, передавая в аргументах параметры. Обычно в таких функциях производится печать в лог-файл, чтобы далее в ходе анализа можно было понять, какие агенты не отрабатывают до конца, какие выполняются слишком долго.

В реальных проектах запуск агентов лучше переносить на планировщик задач cron, чтобы не зависеть от посещаемости. Это легко сделать, если сайт установлен на сервер с BitrixVM. По умолчанию в виртуальной машине cron уже включен.

Меню BitrixVM возьмет на себя конфигурирование сайта и добавления правила в crontab. Если BitrixVM нет, или конфигурация сайта нетиповая, разработчик должен будет выполнить настройку самостоятельно.

Настраивая crontab самостоятельно, не забудьте про параметр `sendmail_path`, для задания корректного отправителя E-mail. При настройке через BitrixVM параметр будет задан автоматически.

Никогда не совмещайте эти два варианта! Настраивая crontab самостоятельно, отключите задачи на cron в меню BitrixVM, и наоборот.

---
### Функция логирования

```php
// init.php
define('BX_AGENTS_LOG_FUNCTION', 'LogAgent');
```

```php
function LogAgent($agent, $operation, $result = false, $return = false)
{
	static $log = [];

	$time = date('Y-m-d-H:i:s');

	if ($operation == 'start') {
		$log[$agent['ID']] = microtime(true);
		\Bitrix\Main\Diag\Debug::writeToFile($_SERVER["REQUEST_TIME_FLOAT"] . '-' . $time . '-' . $agent['ID'] . '-start: ' . $agent['NAME'] .
			' [' . $agent['MODULE_ID'] . '], ' . $agent['AGENT_INTERVAL'], "", "academy.log");
	}
	elseif ($operation == 'finish') {
		\Bitrix\Main\Diag\Debug::writeToFile($_SERVER["REQUEST_TIME_FLOAT"] . '-' . $time . '-' . $agent['ID'] . '-finish (' .
			number_format(microtime(true) - $log[$agent['ID']], 4, '.', ' ') .
			's): ' . $agent['NAME'] . ' [' . $agent['MODULE_ID'] . '], ' . $agent['AGENT_INTERVAL'], "", "academy.log");
	}
}

```

---
### Создание

Создаем [[События]] и почтовый шаблон