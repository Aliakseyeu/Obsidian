
Особый вид отладочных ситуаций — работа с SQL-запросами к БД. Даже если не использовать собственные запросы, а ограничиться готовыми методами ORM, иногда запросы выдают, на первый взгляд, некорректную информацию. Чтобы узнать, какой запрос сформировал API платформы, используйте пару методов \Bitrix\Main\DB\Connection::startTracker и \Bitrix\Main\DB\Connection::stopTracker.

Метод startTracker запустит сбор SQL-запросов. По его окончании, после вызова stopTracker вы сможете получить текст выполненных запросов методом \Bitrix\Main\Diag\SqlTracker::getQueries. Например, для сохранения его в лог-файл или Журнал событий.

При включении трекера, каждый запрос, осуществленный методом \Bitrix\Main\DB\Connection::queryInternal() (ядро D7) будет записываться, также будут записаны время начала и окончания запроса. Поэтому не все запросы осуществленные через старое ядро можно будет отследить таким образом.

Схожие возможности дает Монитор производительности. Запустить монитор можно вручную в административном разделе в двух режимах — полный сбор всех SQL-запросов в течение часа или сбор только медленных запросов в течение недели. Все собранные запросы сохраняются в БД модуля и будут доступны к просмотру администратором сайта на странице “Настройки > Производительность > Запросы SQL”.

Если объявить в dbconn.php переменную $DBDebugToFile как true, все SQL запросы к базе данных и время их выполнения будут записываться в лог-файл /mysql_debug.sql. Ведение такого лога может серьезно замедлить работу сайта, поэтому пользоваться этим стоит кратковременно.

```php
$connection = Application::getConnection();
$tracker = $connection->startTracker();
// SQL запросы
$connection->stopTracker();

$sqlInfo = [
	'expression' => $result->getTrackerQuery()->getSql(),
	'trace' => $result->getTrackerQuery()->getTrace(),
	'time' => $result->getTrackerQuery()->getTime(),
]

$tracker->getQueries();
```